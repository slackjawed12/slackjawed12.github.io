---
layout: single

title: "[AWS] Database Migration Service (AWS DMS) 실무 적용"
categories: AWS
tag: [cloud, aws]
toc: true # table of contents 추가
use_math: true # 수식 쓸 경우 추가
author_profile: true # 포스트 화면에서 작성자 프로필이 나타날지 여부 결정

sidebar:
  nav: "docs"
---

### AWS DMS란?

AWS에서 제공하는 데이터베이스 마이그레이션 서비스이다. 온프레미스 데이터베이스를 AWS의 RDS 등의 여러 데이터베이스로 마이그레이션 할 수 있다.

### 배경 - MySQL 5.7의 연장 지원

&nbsp;&nbsp; 일단 우리가 메인 데이터베이스로 쓰고있던 [AWS RDS for MySQL 5.7 버전이 2024년 2월 29일부로 자동 연장지원 모드로 들어갔다](https://aws.amazon.com/ko/blogs/korea/your-mysql-5-7-and-postgresql-11-databases-will-be-automatically-enrolled-into-amazon-rds-extended-support/). AWS 측에서는 이전부터 이메일로 계속 경고했지만 우리쪽에선 매번 우선순위에 밀려 무시해왔는데, 이는 아예 지원을 끊겠다는 것도 아니고 지원을 연장해준다고 했으므로 DB가 당장 셧다운 될 일도 아니라고 생각했기 때문이었다.</br>
&nbsp;&nbsp; 근데 셧다운만큼이나 더 무서운 문제가 있었으니, 요금 폭탄이었다. 연장지원 모드에 들어가게 되면 해당 버전에 사용요금이 추가로 붙는다. 실제로 요금계산서로 예상비용을 계산해보니, 우리 인스턴스 유형에서 한달에 연장지원으로 치르는 비용만 1600 달러였다. 물론 인스턴스 비용은 별도. 당장 업그레이드 하지 않으면 안되었다.</br>

### DMS 적용 이유

&nbsp;&nbsp; 사실 MySQL 5.7을 MySQL 8.0으로 메이저 버전만 업그레이드 하는 것은 제약조건들에만 걸리지 않으면 어렵지 않은 편이었다. MySQL 공식문서에서도 쉘 명령어로 검증할 것들을 자동으로 제공해주고 있었고, 이전에 한번 테스트 해본 적도 있었다. </br>
&nbsp;&nbsp;심지어 RDS를 사용하는 경우 블루/그린 배포를 사용하면 일일이 명령어로 버전 업그레이드 할 것 없이 자동으로 업그레이드 해준다. 그럼에도 더 무거운 작업인 DMS를 사용한 이유가 있는데, 주어진 과제가 세 가지를 동시에 만족해야 했기 때문이다.

1. MySQL을 5.7에서 8.0으로 업그레이드 할 것
2. RDS for MySQL을 Aurora MySQL로 변경하고 클러스터 구조를 변경할 것
3. 이전 DB가 속한 VPC(old VPC)를 새 VPC(new VPC)로 옮길 것

&nbsp;&nbsp;여기서 1번만 해당하면 블루/그린 배포로 간단히 업그레이드 하면 된다. 2번부터 DMS 카드를 생각했는데, RDS를 블루그린 배포로 패치할 시 RDS -> RDS 패밀리로는 가능한데, RDS -> Aurora 로는 변경이 불가능한 것 같았다. 즉, 인스턴스 클래스를 업그레이드 하거나, 엔진의 메이저 버전을 업그레이드 할 수는 있으나 인스턴스의 유형 자체를 바꾸지는 못하는 것 같았다. 또한 3번 역시 문제였는데, 블루/그린 배포를 만들면 같은 가용영역 안에서만 배포가 생성됐고, 다른 vpc에 배포를 만들거나 하는 설정은 불가능한 것 같았다.

&nbsp;&nbsp; 그럼 가능한 경우 최대한 블루/그린 배포를 사용하는 것이 왜 좋을까? 먼저, 엔드포인트를 애플리케이션 코드에서 바꿀 필요가 없어 다운타임이 없다. 즉, 서비스 중단 없이 데이터베이스를 패치하므로 매우 편리하다. 또한 논리적 복제가 계속 일어나고 있어, 전환 중에 old blue 배포에 쓰기 작업이 계속 진행되어도 new blue 배포에 그대로 반영된다. 유실의 문제가 전혀 없다. DMS의 경우에도 CDC로 이런 부분을 커버하고는 있으나, 엔드포인트를 애플리케이션 코드에서 갈아끼워야하므로 배포시간만큼의 중단시간이 발생하게 된다.

&nbsp;&nbsp; 3번은 테스트 당시에는 제약조건이라고 생각했는데, 어차피 복제를 만들고나면 VPC를 따로 변경해주면 되기 때문에 아예 상관없는 문제인 것 같다. 다만 DMS로 대상 데이터베이스를 새 VPC에 만들어두고 작업하면 변경 없이 VPC를 작업할 수 있기는 하다. 3번 때문에 마이그레이션 작업 시 VPC 피어링 설정이 추가로 필요했다.

### DMS 적용 과정

&nbsp;&nbsp;DMS의 구성 요소는 크게 소스/타겟 데이터베이스, 그리고 중간에 그 둘 간의 복제작업을 하는 복제 인스턴스가 있다. 마지막으로 복제 작업 자체를 정의하는 태스크(Task)가 있다.</br>
순서는 타겟 데이터베이스를 만들고(소스는 있을 것이므로), 복제 인스턴스를 생성한 다음, 소스/타겟 데이터베이스의 엔드포인트를 설정해서 복제 인스턴스와의 연결을 테스트한다. 마지막으로 마이그레이션 태스크를 정의해서 마이그레이션을 어떻게 진행할 것인지 설정하면 바로 마이그레이션이 시작된다.

1. (MySQL인 경우) 소스 데이터베이스 파라미터 변경

&nbsp;&nbsp;변경 데이터 캡처(CDC) 설정을 하려면 MySQL 5.7의 경우 binlog_format 파라미터를 row로 설정해야 한다고 한다. 정확히 어떤 맥락에서 이것이 필요한지는 더 공부해봐야겠지만 지속 복제 작업은 필수이므로 반드시 설정해줘야 한다.

2. 타겟 데이터베이스 생성

먼저 마이그레이션 타겟이 될 데이터베이스 인스턴스를 생성해야한다.

3. 복제 인스턴스 생성

복제 인스턴스를 생성하거나, 서버리스로 진행해서 인프라 관리를 AWS에 맡길 수도 있는데, 서버리스로 진행할 경우 2024-03-07 기준 마이그레이션 인스턴스 유형이 제한된다. 요금은 복제 인스턴스보다 서버리스가 더 저렴하다.

4. 소스 엔드포인트와 타겟 엔드포인트 연결

소스, 타겟 데이터베이스 연결을 담당할 엔드포인트를 각각 만들어준다. 마지막에 연결을 테스트해볼 수 있는데, 빼먹은 보안그룹 설정 같은 것들을 확인할 수 있으니 반드시 연결이 성공적으로 되는지 테스트해보자.

5. 태스크 생성

이제 마이그레이션 작업 전반을 정의할 태스크를 생성한다. 태스크가 생성되면 실제로 마이그레이션 작업이 이뤄진다.

&nbsp;&nbsp;이렇게 4-5단계를 거치고 나면 아주 긴 시간동안 마이그레이션 작업이 진행된다. 이 동안 기존 데이터베이스에 부하가 많이 가는 것은 아닌가 했는데, 지표를 보면 딱히 큰 변화는 없었다. 마이그레이션 진행 중에 소스 데이터베이스에서 쓰기 작업이 발생해도 CDC가 적용되어 있으므로 타겟 데이터베이스에 변경사항이 그대로 반영된다.</br>
&nbsp;&nbsp;주의할 것은, 타겟 데이터베이스에 auto_increment나 cascade 설정들은 마이그레이션 되지 않는다는 것이다. 이런 조건들은 스크립트를 따로 만들어서 해당되는 테이블에 적용을 해주어야 한다. 아직 더 좋은 방법은 찾지 못했다.
